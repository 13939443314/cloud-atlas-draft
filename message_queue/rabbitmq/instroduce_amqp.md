# AMQP概要

* AMQP架构中最主要的组件是`交换机`、`队列`和`绑定`。
* 根据绑定规则将队列绑定到交换机上
* 消息是发不到交换机上的
* 有3种类型交换机：`direct`、`fanout`（广播）、`topic`（日志使用，不同源头的消息能够达到同一个队列）
* 基于消息的路由键和交换机类型，服务器会决定将消息投递到哪个队列中。

## 多租户模式：虚拟主机和隔离

每个RabbitMQ服务器都能够创建虚拟消息服务器，vhost，拥有自己的队列、交换机和绑定，以及自己定义的权限。这样可以确保安全使用RabbitMQ服务于不同的程序，类似虚拟机对比物理服务器，实现各个实例间逻辑上分离，允许为不同应用程序安全保密地运行数据。

此外，使用虚拟消息服务器可以将不同用户区分开，并且可以避免队列和交换机的命名冲突。

`vhost`是AMQP概念的基础，必须在连接时指定。由于 RabbitMQ包含了开箱即用的默认`vhost`：`/`，所以如果不需要多个vhost，则默认就可以了。

> 通过使用缺省的`guest`用户名和`guest`密码就可以访问默认vhost。但是，为了安全起见，应该更改这个默认设置。

在RabbitMQ中，权限控制是以`vhost`为单位的。

当在RabbitMQ中创建一个用户时，用户会被指派给至少一个`vhost`，并且只能访问被指派的`vhost`内的队列、交换机和绑定。在设计消息队列架构师，一定要牢记`vhost`之间时绝对隔离的。这即保证了安全性也保证了可移植性。

此外，RabbitMQ还支持跨服务器的`vhost迁移`，并马上开始处理新的负载而不会有任何命名冲突。

> 在RabbitMQ集群上创建`vhost`时，整个集群都会创建这个`vhost`

* 查看`vhost`列表：

```
sudo rabbitmqctl list_vhosts
```

* 添加`vhost`

```
sudo rabbitmqctl add_vhost [vhost_name]
```

举例：

```
sudo rabbitmqctl add_vhost nginx_log
```

# 消息持久化

**RabbitMQ队列`默认情况下不是持久化的`**

由于**默认**RabbitMQ队列和交换机的`durable`属性设置是`false`，所以奔溃（重启）队列和交换机（以及里面的消息）都会消失。

能从AMQP服务器奔溃中恢复的消息，称为持久化消息，必须同时满足以下条件：

* 消息发布前，需要把它的"投递模式"（delivery mode）选项设置为`2`（持久）
* 发送到持久化的交换机
* 达到持久化的队列

RabbitMQ确保持久性消息能够从服务器重启中恢复是通过将消息写入磁盘上的持久化日志文件 -- 当持久化消息到达交换机时，Rabbit会在消息提交到日志文件后才发送响应。

注意，如果该消息路由到非持久化队列，就会从持久性日志中移除，并且无法从服务器重启中恢复。

一旦持久性消息被消费并确认过的话，RabbitMQ会在持久化日志中把这条消息标记为`等待垃圾收集`。

如果持久性消息没有被消费之前RabbitMQ重启的话，服务器会自动重建交换机和队列（以及绑定），重播持久性日志文件中的消息到合适的队列或交换机上（取决于RabbitMQ服务器宕机时消息处于路由过程的哪个环节）。

> 不是所有的消息都应该启用持久化，因为这样会付出性能代价（磁盘写入比内存写入慢很多倍），并极大减少RabbitMQ服务器每秒可处理消息总数。